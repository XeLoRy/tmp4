<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OAuth Callback</title>
</head>
<body>
  <p id="status">Authentification en cours...</p>
  <script>
    (function() {
      var status = document.getElementById('status');
      var params = new URLSearchParams(window.location.search);
      var token = params.get('token');
      var error = params.get('error');

      console.log('=== OAUTH CALLBACK ===');
      console.log('Token:', token ? 'present (' + token.length + ' chars)' : 'missing');
      console.log('window.opener:', window.opener ? 'present' : 'NULL');
      console.log('window.parent:', window.parent !== window ? 'different from self' : 'same as self');

      if (error) {
        status.textContent = 'Erreur: ' + error;
        return;
      }

      if (!token) {
        status.textContent = 'Pas de token recu.';
        return;
      }

      // Format attendu par Decap CMS
      var authData = { token: token, provider: 'github' };
      var message = 'authorization:github:success:' + JSON.stringify(authData);

      console.log('Message format:', message.substring(0, 50) + '...');

      // Stocker dans localStorage - format Decap CMS natif
      try {
        // Format que Decap CMS lit au demarrage
        localStorage.setItem('netlify-cms-user', JSON.stringify({
          token: token,
          backendName: 'github'
        }));
        // Cle pour declencher storage event dans la fenetre principale
        localStorage.setItem('decap-cms-auth', JSON.stringify(authData));
        console.log('Token stored in localStorage');
      } catch (e) {
        console.log('localStorage error:', e);
      }

      // Essayer BroadcastChannel comme fallback
      if (typeof BroadcastChannel !== 'undefined') {
        try {
          var channel = new BroadcastChannel('decap-cms-auth');
          channel.postMessage(authData);
          console.log('Message sent via BroadcastChannel');
          channel.close();
        } catch (e) {
          console.log('BroadcastChannel error:', e);
        }
      }

      var messageSent = false;

      // Essayer window.opener d'abord
      if (window.opener) {
        try {
          window.opener.postMessage(message, '*');
          console.log('Message sent via window.opener');
          messageSent = true;
        } catch (e) {
          console.log('window.opener.postMessage error:', e);
        }
      }

      // Essayer aussi window.parent (pour les iframes)
      if (window.parent && window.parent !== window) {
        try {
          window.parent.postMessage(message, '*');
          console.log('Message sent via window.parent');
          messageSent = true;
        } catch (e) {
          console.log('window.parent.postMessage error:', e);
        }
      }

      if (messageSent) {
        status.textContent = 'Authentification reussie! Fermeture...';
        setTimeout(function() {
          window.close();
        }, 1500);
      } else {
        // Pas de fenetre parente - le storage event va notifier la fenetre principale
        status.textContent = 'Authentification reussie! Vous pouvez fermer cette fenetre.';
        console.log('No parent window - storage event should notify main window');

        // La fenetre principale va detecter le changement via storage event et se recharger
        // Ne pas rediriger ici car ca empecherait la fenetre principale de recevoir l'event
      }
    })();
  </script>
</body>
</html>
