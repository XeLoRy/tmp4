<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OAuth Callback</title>
</head>
<body>
  <p id="status">Authentification en cours...</p>
  <script>
    (function() {
      var status = document.getElementById('status');
      var params = new URLSearchParams(window.location.search);
      var token = params.get('token');
      var error = params.get('error');

      console.log('Callback loaded, token:', token ? 'present' : 'missing');
      console.log('window.opener:', window.opener ? 'present' : 'missing');

      if (error) {
        status.textContent = 'Erreur: ' + error;
        return;
      }

      if (!token) {
        status.textContent = 'Pas de token recu.';
        return;
      }

      if (!window.opener) {
        status.textContent = 'Token recu mais pas de fenetre parente.';
        return;
      }

      // Format attendu par Decap CMS
      var message = 'authorization:github:success:' + JSON.stringify({
        token: token,
        provider: 'github'
      });

      console.log('Sending message:', message);

      // Envoyer au parent avec "*" pour accepter tous les origins
      window.opener.postMessage(message, '*');

      status.textContent = 'Token envoye! Fermeture...';

      setTimeout(function() {
        window.close();
      }, 1500);
    })();
  </script>
</body>
</html>
